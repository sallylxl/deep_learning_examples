apiVersion: kubeflow.org/v1
kind: PyTorchJob
metadata:
  name: ${JOB_PREFIX}-n${GPU_NUMS}-gbs${GBS}-ckpt${ENABLE_CKPT}-${RUN_ID}
  namespace: t-hisys-xlliu
spec: 
  pytorchReplicaSpecs:
    Master:
      replicas: 1
      restartPolicy: Never
      template:
        metadata:
          annotations:
            sidecar.istio.io/inject: "false"
        spec: &job-spec
          containers:
          - args:
            - "echo $NODE_NAME && export NODE_RANK=$RANK &&  unset RANK && export CUDA_DEVICE_MAX_CONNECTIONS=1 && \
               cd ${DEEP_LEARNING_EXAMPLES_DIR}/training/nemo/neva && \
               DEEP_LEARNING_EXAMPLES_DIR=${DEEP_LEARNING_EXAMPLES_DIR} BASE_RESULTS_DIR=${BASE_RESULTS_DIR} \
               PRETRAINED_LLM_PATH=${PRETRAINED_LLM_PATH} \
	       PRETRAINED_VISION_ENCODER_PATH=${PRETRAINED_VISION_ENCODER_PATH} \
	       DATASET_DIR=${DATASET_DIR} \
               RUN_ID=${RUN_ID} GBS=$GBS MBS=$MBS PP=$PP TP=$TP MAX_STEPS=${MAX_STEPS} \
               ENABLE_CKPT=${ENABLE_CKPT} \
               bash run_nemo_${MODEL}.sh"
            command:
            - /usr/bin/env
            - bash
            - -c
            env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: TZ
              value: CST-8
            - name: UCX_ALLOC
              value: "md,mmap,heap"
            - name:  UCX_MM_HUGETLB_MODE
              value: "n"
            - name: NCCL_IB_QPS_PER_CONNECTION
              value: "2"
            - name: NCCL_NVLS_ENABLE
              value: "0"
            - name: NCCL_NET_GDR_LEVEL
              value: "3"
            - name: NCCL_IB_TIMEOUT
              value: "22"
            image: registry-ap-southeast.scitix.ai/siflow/nemo:24.07-a8f07bee
            imagePullPolicy: Always 
            name: pytorch
            resources:
              limits:
                cpu: "80"
                memory: 800Gi
                nvidia.com/gpu: "8"
                rdma/hca_shared_devices_all: "1"
              requests:
                cpu: "80"
                memory: 800Gi
                nvidia.com/gpu: "8"
                rdma/hca_shared_devices_all: "1"
            securityContext:
              capabilities:
                add:
                - IPC_LOCK
            volumeMounts:
            - mountPath: /dev/shm
              name: dev-shm
            - mountPath: /data
              name: data
            - mountPath: /models/preset
              name: siflow-models-hisys-xlliu
            - mountPath: /datasets/preset
              name: siflow-datasets-hisys-xlliu
          volumes:
          - emptyDir:
              medium: Memory
            name: dev-shm
          - name: data
            persistentVolumeClaim:
              claimName: xlliu-test
          - name: siflow-models-hisys-xlliu 
            persistentVolumeClaim:
              claimName: siflow-models
              readOnly: true
          - name: siflow-datasets-hisys-xlliu 
            persistentVolumeClaim:
              claimName: siflow-datasets
              readOnly: true
          #- hostPath:
          #    path: /data
          #    type: ""
          #  name: data
          tolerations:
            - effect: NoSchedule
              key: node.kubernetes.io/unschedulable
              operator: Exists
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: scitix.ai/gpu-type
                        operator: In
                        values:
                          - h100nvlink80
                      #- key: test0829
                      #  operator: In
                      #  values:
                      #    - "true"

    Worker:
      replicas: $WORKER_NUMS
      restartPolicy: Never
      template:
        metadata:
          annotations:
            sidecar.istio.io/inject: "false"
        spec:
          <<: *job-spec
